---
title: Creating and Relating Atlases
---

* Single-cell analysis often looks like map making
* Issue is we don't have common features on our two maps
  - only a few shared landmarks

* To make this analogy concrete, we're going to look at the data
* Making atlases
  - Let's show how you can make these atlases, using clustering
  - Also using U-Map or PCA
  - Future: We should also make these using spatial or graph information. So,
    being close by in on an atlas means that you have similar graph features as
    well.
* Interpreting atlases
  - Is over / under representation in some regions of the map related to good /
    poor outcomes?
* Relating atlases
  - Are there similar interpretations coming from the two different datasets? In
    what ways are the stories discrepant?
  - Can we try to map clusters / PCA's onto each other? At the least, we can
    calculate the distance between centroids, using shared features. A more
    sophisticated / imputation-like idea is to link the atlases in a more
    continuous way, using some sort of learned (inverse) function. But let's not
    worry about that.

## Preparing Data

```{r}
library("ggplot2")
library("dplyr")
library("reshape2")
library("tibble")
library("forcats")
source("preprocessing.R")
theme_set(theme_bw() + theme(panel.grid=element_blank()))
data_dir <- file.path("..", "Data")
```

While we're developing the analysis, we'll use subsampled versions of all the
data. This loads the masstag and mibi datasets.

```{r}
load(file.path(data_dir, "masstagSCE.rda"))
masstag <- data_list("sce")
load(file.path(data_dir, "mibiSCE.rda"))

masstag <- subsample_experiments(masstag)
mibi <- subsample_experiments(list(mibi.sce))[[1]]
```

This next step is optional -- it transforms the original intensities into
quantiles, to make measures comparable across experiments.

First, just to get intuition, look at some transforms.
```{r}
for (j in seq_len(10)) {
  r <- rank(assay(mibi[j, ])) / ncol(mibi)
  plot(assay(mibi[j, ]), r)
}
```

Now we'll make the transformation. (tk should create an rmarkdown parameter to skip this transformation).
```{r}
mibi <- quantile_transform(mibi)
for (i in seq_along(masstag)) {
  masstag[[i]] <- quantile_transform(masstag[[i]])
}
```

## Clustering

* k-means on the raw proteins, separately for each of the cell types.
 - This means that each cluster will have to be marked by celltype-K, rather
   than just K.
 - Another consequence is that we'll have a small set of U-Maps for each
   patient, one for each cell type

```{r}
plot(hclust(dist(assay(masstag[[1]]))))
```


## Clusters vs. Phenotypes

* Cluster membership vs. cell types
* % cluster memberships in sample vs. phenotype
* % cluster memberships in sample vs. combinations of phenotypes

## Dimensionality Reduction

* Run a dimensionality reduction algo on the matrix
* Plot the resulting map for a couple of samples
* Overlay the cell types or certain CD's on them
* Write a function to count the proportions / amounts of cells in different
  parts of the map

## Reduction vs. Phenotypes

* Run a lasso between proportions in different parts of the map and the observed
  phenotypes (say, survival, or cancer grade, or some combination of those)

## Repeat everything on the other dataset

## Relating approaches

* Do you observe similar clusters among better / worse outcome patients?
  - If so, then gives some basis for performing clustering on MIBI that uses
    spatial info, and imputing that spatial info onto the Cytof
* Can you try to "reverse" the lasso from above? From a fixed phenotypic
  configuration, come up with a distribution over plausible maps, for each of
  the two types of data.
